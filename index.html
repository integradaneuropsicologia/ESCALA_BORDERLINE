<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Escala McLean de Triagem para Transtorno de Personalidade Borderline</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}
  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220}
  .q h3{margin:0 0 8px;font-size:1rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Triagem para Transtorno de Personalidade Borderline</h1>
    <p class="muted">Responda com base em como você tem se sentido e agido <strong>recentemente</strong>.</p>

    <!-- Dados do paciente (por token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ESCALA_BORDERLINE" };
const CODE = "ESCALA_BORDERLINE";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["ESCALA_BORDERLINE"]; // colunas de liberação no Patients com valor "sim"

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent=text;
  el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display="block";
}
function hideBox(id){
  const el=$(id); if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d=onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d]=String(iso).split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function POST(url, body){
  const r=await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function PATCH(url, body){
  const r=await fetch(url,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] });
}
async function sheetPatchBy(sheet, column, value, data){
  return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data });
}
function goPortalWithToken(){
  const TOKEN=qs("token");
  try{
    const u=new URL(PORTAL_URL,location.href);
    if(TOKEN) u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+(TOKEN?sep+"token="+encodeURIComponent(TOKEN):"");
  }
}

/* ========= ITENS ========= */
const ITEMS = [
  "Algum de seus relacionamentos foi problemático, com muitas discussões ou separações frequentes?",
  "Você se machucou fisicamente de forma deliberada (por exemplo, deu um soco em si mesmo, se cortou, se queimou ou tentou suicídio)?",
  "Você já teve pelo menos dois outros problemas com impulsividade (por exemplo, comer compulsivamente, gastar muito, beber demais, explosões verbais)?",
  "Você tem estado muito mal-humorado?",
  "Você já sentiu muita raiva muitas vezes, agindo de maneira explosiva ou sarcástica?",
  "Você costuma desconfiar de outras pessoas?",
  "Você frequentemente sente que está perdendo a noção da realidade?",
  "Você tem se sentido cronicamente vazio?",
  "Você já sentiu muitas vezes que não sabe quem você é ou qual sua identidade?",
  "Você fez esforços desesperados para evitar se sentir abandonado ou ser abandonado (por exemplo, ligou repetidamente para alguém para se assegurar de que ainda se importava, implorou para que não o[a] deixassem, agarrou-se a eles fisicamente)?"
];
const CHOICES = [
  {label:"SIM", value:1},
  {label:"NÃO", value:0}
];

function classif(total){
  // padrão clássico MSI-BPD: ≥5 sugere rastreio positivo
  return total <= 4
    ? "sem indicativos de borderline"
    : "indícios de borderline";
}

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";

  // pequeno "progresso: x/10"
  let prog=document.getElementById("bpdProgress");
  if(!prog){
    prog=document.createElement("div");
    prog.id="bpdProgress";
    prog.className="muted";
    prog.style.margin="0 0 10px";
    prog.textContent="0/10 respondidas";
    $("#form").insertBefore(prog,host);
  }

  ITEMS.forEach((text,idx)=>{
    const qn=String(idx+1).padStart(2,"0");

    const wrap=document.createElement("div");
    wrap.className="q";
    wrap.setAttribute("role","group");
    wrap.setAttribute("aria-labelledby",`lbl${qn}`);

    wrap.innerHTML=`<h3 id="lbl${qn}">${idx+1}. ${text}</h3>`;

    const opts=document.createElement("div");
    opts.className="opts";

    CHOICES.forEach(c=>{
      const id=`q${qn}_${c.value}`;
      const lab=document.createElement("label");
      lab.className="opt";
      lab.innerHTML=
        `<input type="radio" name="q${qn}" id="${id}" value="${c.value}" required>`+
        `<span>${c.label}</span>`;
      opts.appendChild(lab);
    });

    wrap.appendChild(opts);
    host.appendChild(wrap);
  });

  host.addEventListener("change", ()=>{
    const answered=document.querySelectorAll('#qs input[type="radio"]:checked').length;
    $("#bpdProgress").textContent=`${answered}/${ITEMS.length} respondidas`;
    autosaveAnswers();
  });
}

/* ========= AUTOSAVE ========= */
function autosaveAnswers(){
  const answers={};
  for(let i=1;i<=ITEMS.length;i++){
    const qn=`q${String(i).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    if(sel) answers[qn]=Number(sel.value);
  }
  try{
    localStorage.setItem(
      AUTOSAVE_KEY,
      JSON.stringify({code:CODE,token:qs("token"),answers})
    );
  }catch(_){}
}

function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return;
    const {answers}=JSON.parse(raw)||{};
    if(!answers) return;
    Object.entries(answers).forEach(([qn,val])=>{
      const el=document.querySelector(`input[name="${qn}"][value="${val}"]`);
      if(el) el.checked=true;
    });
    const answered=Object.keys(answers).length;
    $("#bpdProgress").textContent=`${answered}/${ITEMS.length} respondidas`;
  }catch(_){}
}

function clearAutosave(){
  try{ localStorage.removeItem(AUTOSAVE_KEY); }catch(_){}
}

/* ========= TEXTO LEGÍVEL (pergunta => resposta) ========= */
function collectQuestionsAnswers(){
  const out=[];
  ITEMS.forEach((txt, idx)=>{
    const qn=`q${String(idx+1).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    let human="—";
    if(sel){
      human = Number(sel.value)===1 ? "SIM" : "NÃO";
    }
    out.push(`${idx+1}. ${txt} => ${human}`);
  });
  return out.join("\n");
}

/* ========= ESTADO ========= */
let patient=null;
let CPF="";
let startAt=Date.now();

/* ========= BOOT ========= */
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    // token válido?
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length) throw new Error("Token inválido ou expirado.");
    const tokenRow=trows[0];
    const disabled = String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Peça um novo link.");

    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    // paciente
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    // liberado pra esse paciente?
    const isAllowed = RELEASE_KEYS.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você. Entre em contato com o consultório.","err");
      return;
    }

    // já respondeu?
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    renderPatientInfo();
    renderQuestions();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");

    startAt=Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.","err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  [
    ["Nome",        patient.nome || "-"],
    ["CPF",         maskCPF(patient.cpf)],
    ["Nascimento",  fmtDateISO(patient.data_nascimento)],
    ["E-mail",      patient.email || "-"],
    ["WhatsApp",    patient.whatsapp || "-"]
  ].forEach(([k,v])=>{
    const d=document.createElement("div");
    d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  });
}

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending=true;
  hideBox("#msg");

  const btn=$("#btnSubmit");
  const originalText=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // validar se todas foram respondidas
    let totalYes=0;
    const answers={};
    let firstMissing=null;

    for(let i=1;i<=ITEMS.length;i++){
      const qn=`q${String(i).padStart(2,"0")}`;
      const sel=document.querySelector(`input[name="${qn}"]:checked`);
      if(!sel){
        if(!firstMissing) firstMissing=i;
        continue;
      }
      const v=Number(sel.value); // 1=SIM, 0=NÃO
      totalYes+=v;
      answers[qn]=v;
    }

    if(firstMissing){
      setBox("#msg", `Responda a questão ${firstMissing}.`, "warn");
      document.getElementById(`lbl${String(firstMissing).padStart(2,"0")}`)?.scrollIntoView({behavior:"smooth",block:"center"});
      sending=false;
      btn.disabled=false;
      btn.textContent=originalText;
      return;
    }

    // double-check se já enviou (aba Scores)
    const again=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // classificação
    const categoria = classif(totalYes);

    // duração
    const durationSec = Math.round((Date.now()-startAt)/1000);

    // texto pergunta => resposta para laudo
    const questionsStr = collectQuestionsAnswers();

    // métricas extras
    const max_total = ITEMS.length;
    const metricsObj = {
      answers,                         // bruto (ex.: {q01:1,q02:0,...})
      total_yes: totalYes,             // quantos "SIM"
      max_total,                       // 10
      percent_total: Number((totalYes / max_total).toFixed(4)),
      classification: categoria,
      duration_sec: durationSec
    };

    // grava linha no Scores
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: totalYes,             // nº de "SIM"
      categoria: categoria,        // texto clínico curto
      metrics: "",
      questions: questionsStr      // perguntas + respostas legíveis
    });

    // marca como feito no Patients
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,doneUpdates);

    clearAutosave();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false;
    btn.disabled=false;
    btn.textContent=originalText;
  }
});
</script>


</body>
</html>
