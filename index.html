<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Escala McLean de Triagem para Transtorno de Personalidade Borderline</title>
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#0f172a;
    --muted:#6b7280;
    --pri:#4f46e5;
    --ok:#16a34a;
    --err:#b91c1c;
    --warn:#f59e0b;
    --surface:#f9fafb;
  }
  [data-theme="dark"]{
    --bg:#0f172a;
    --card:#111827;
    --line:#1f2937;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --pri:#4f46e5;
    --ok:#22c55e;
    --err:#ef4444;
    --warn:#f59e0b;
    --surface:#0b1220;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition:background .2s ease,color .2s ease;
  }
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    box-shadow:0 18px 40px rgba(15,23,42,.15);
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:6px;
  }
  .header-main{flex:1 1 auto}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}

  .theme-btn{
    align-self:flex-start;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--text);
    font-size:.85rem;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .theme-btn:hover{background:var(--surface)}

  @media(max-width:720px){
    .header{flex-direction:column-reverse;align-items:flex-start}
  }

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin:12px 0 6px
  }
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:var(--muted);
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.03em;
  }

  .q{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--surface);
  }
  .q h3{margin:0 0 8px;font-size:1rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{
    display:flex;
    align-items:center;
    gap:6px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:10px;
    background:transparent;
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,transform .05s ease;
  }
  .opt:hover{
    background:rgba(79,70,229,0.06);
    border-color:#4f46e5;
    transform:translateY(-1px);
  }
  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;height:0;
    position:absolute;
    opacity:0;
  }
  .opt span{font-weight:600}
  .opt:has(input:checked){
    background:rgba(79,70,229,0.10);
    border-color:#4f46e5;
    box-shadow:0 0 0 1px #4f46e5 inset;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
  }
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#166534;
  }
  .errbox{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#7f1d1d;
  }
  .warnbox{
    background:#fffbeb;
    border:1px solid #fef3c7;
    color:#92400e;
  }
  [data-theme="dark"] .okbox{
    background:#052e1a;
    border-color:#114d2a;
    color:#b3f7c1;
  }
  [data-theme="dark"] .errbox{
    background:#3b0d0d;
    border-color:#5b1919;
    color:#ffd0d0;
  }
  [data-theme="dark"] .warnbox{
    background:#3a2903;
    border-color:#5c4307;
    color:#ffe6b0;
  }

  #bpdProgress{
    margin:0 0 10px;
    font-size:.9rem;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="header-main">
        <h1>Triagem para Transtorno de Personalidade Borderline</h1>
        <p class="muted">Responda com base em como voc√™ tem se sentido e agido <strong>recentemente</strong>.</p>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">üåô Modo escuro</button>
    </div>

    <!-- Dados do paciente (por token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="bpdProgress" class="muted">0/10 respondidas</div>
      <div id="qs"></div>
      <div style="margin-top:14px">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ESCALA_BORDERLINE" };
const CODE = "ESCALA_BORDERLINE";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["ESCALA_BORDERLINE"]; // colunas de libera√ß√£o no Patients com valor "sim"

/* ========= THEME (CLARO/ESCURO) ========= */
const THEME_KEY = `${CODE}_THEME`;

function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  const btn = document.querySelector("#themeToggle");
  if(btn){
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
  }
}
function initTheme(){
  let theme = "dark"; // mant√©m padr√£o escuro que voc√™ j√° usava
  try{
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === "dark" || saved === "light") theme = saved;
  }catch(_){}
  applyTheme(theme);

  const btn = document.querySelector("#themeToggle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); }catch(_){}
    });
  }
}
if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", initTheme);
} else {
  initTheme();
}

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent=text;
  el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display="block";
}
function hideBox(id){
  const el=$(id); if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d=onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d]=String(iso).split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function POST(url, body){
  const r=await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function PATCH(url, body){
  const r=await fetch(url,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] });
}
async function sheetPatchBy(sheet, column, value, data){
  return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data });
}
function goPortalWithToken(){
  const TOKEN=qs("token");
  try{
    const u=new URL(PORTAL_URL,location.href);
    if(TOKEN) u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+(TOKEN?sep+"token="+encodeURIComponent(TOKEN):"");
  }
}

/* ========= ITENS ========= */
const ITEMS = [
  "Algum de seus relacionamentos foi problem√°tico, com muitas discuss√µes ou separa√ß√µes frequentes?",
  "Voc√™ se machucou fisicamente de forma deliberada (por exemplo, deu um soco em si mesmo, se cortou, se queimou ou tentou suic√≠dio)?",
  "Voc√™ j√° teve pelo menos dois outros problemas com impulsividade (por exemplo, comer compulsivamente, gastar muito, beber demais, explos√µes verbais)?",
  "Voc√™ tem estado muito mal-humorado?",
  "Voc√™ j√° sentiu muita raiva muitas vezes, agindo de maneira explosiva ou sarc√°stica?",
  "Voc√™ costuma desconfiar de outras pessoas?",
  "Voc√™ frequentemente sente que est√° perdendo a no√ß√£o da realidade?",
  "Voc√™ tem se sentido cronicamente vazio?",
  "Voc√™ j√° sentiu muitas vezes que n√£o sabe quem voc√™ √© ou qual sua identidade?",
  "Voc√™ fez esfor√ßos desesperados para evitar se sentir abandonado ou ser abandonado (por exemplo, ligou repetidamente para algu√©m para se assegurar de que ainda se importava, implorou para que n√£o o[a] deixassem, agarrou-se a eles fisicamente)?"
];
const CHOICES = [
  {label:"SIM", value:1},
  {label:"N√ÉO", value:0}
];

function classif(total){
  // padr√£o cl√°ssico MSI-BPD: ‚â•5 sugere rastreio positivo
  return total <= 4
    ? "sem indicativos de borderline"
    : "ind√≠cios de borderline";
}

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";

  ITEMS.forEach((text,idx)=>{
    const qn=String(idx+1).padStart(2,"0");

    const wrap=document.createElement("div");
    wrap.className="q";
    wrap.setAttribute("role","group");
    wrap.setAttribute("aria-labelledby",`lbl${qn}`);

    wrap.innerHTML=`<h3 id="lbl${qn}">${idx+1}. ${text}</h3>`;

    const opts=document.createElement("div");
    opts.className="opts";

    CHOICES.forEach(c=>{
      const id=`q${qn}_${c.value}`;
      const lab=document.createElement("label");
      lab.className="opt";
      lab.innerHTML=
        `<input type="radio" name="q${qn}" id="${id}" value="${c.value}" required>`+
        `<span>${c.label}</span>`;
      opts.appendChild(lab);
    });

    wrap.appendChild(opts);
    host.appendChild(wrap);
  });

  host.addEventListener("change", ()=>{
    const answered=document.querySelectorAll('#qs input[type="radio"]:checked').length;
    $("#bpdProgress").textContent=`${answered}/${ITEMS.length} respondidas`;
    autosaveAnswers();
  });
}

/* ========= AUTOSAVE ========= */
function autosaveAnswers(){
  const answers={};
  for(let i=1;i<=ITEMS.length;i++){
    const qn=`q${String(i).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    if(sel) answers[qn]=Number(sel.value);
  }
  try{
    localStorage.setItem(
      AUTOSAVE_KEY,
      JSON.stringify({code:CODE,token:qs("token"),answers})
    );
  }catch(_){}
}

function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return;
    const {answers}=JSON.parse(raw)||{};
    if(!answers) return;
    Object.entries(answers).forEach(([qn,val])=>{
      const el=document.querySelector(`input[name="${qn}"][value="${val}"]`);
      if(el) el.checked=true;
    });
    const answered=Object.keys(answers).length;
    $("#bpdProgress").textContent=`${answered}/${ITEMS.length} respondidas`;
  }catch(_){}
}

function clearAutosave(){
  try{ localStorage.removeItem(AUTOSAVE_KEY); }catch(_){}
}

/* ========= QUESTIONS JSON ========= */
function collectQuestionsAnswersJSON(){
  const out=[];
  ITEMS.forEach((txt, idx)=>{
    const i = idx+1;
    const qn=`q${String(i).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    let value=null;
    let label="";
    if(sel){
      value = Number(sel.value);
      label = value===1 ? "SIM" : "N√ÉO";
    }
    out.push({
      id: i,
      code: qn,
      text: txt,
      value,
      label
    });
  });
  return out;
}

/* ========= ESTADO ========= */
let patient=null;
let CPF="";
let startAt=Date.now();

/* ========= BOOT ========= */
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){
      setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err");
      return;
    }

    // token v√°lido?
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length) throw new Error("Token inv√°lido ou expirado.");
    const tokenRow=trows[0];
    const disabled = String(tokenRow.disabled||"n√£o").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Pe√ßa um novo link.");

    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    // paciente
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length) throw new Error("Paciente n√£o encontrado.");
    patient=prows[0];

    // liberado pra esse paciente?
    const isAllowed = RELEASE_KEYS.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™. Entre em contato com o consult√≥rio.","err");
      return;
    }

    // j√° respondeu?
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    renderPatientInfo();
    renderQuestions();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");

    startAt=Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.","err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  [
    ["Nome",        patient.nome || "-"],
    ["CPF",         maskCPF(patient.cpf)],
    ["Nascimento",  fmtDateISO(patient.data_nascimento)],
    ["E-mail",      patient.email || "-"],
    ["WhatsApp",    patient.whatsapp || "-"]
  ].forEach(([k,v])=>{
    const d=document.createElement("div");
    d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  });
}

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending=true;
  hideBox("#msg");

  const btn=$("#btnSubmit");
  const originalText=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    // validar se todas foram respondidas
    let totalYes=0;
    const answers={};
    let firstMissing=null;

    for(let i=1;i<=ITEMS.length;i++){
      const qn=`q${String(i).padStart(2,"0")}`;
      const sel=document.querySelector(`input[name="${qn}"]:checked`);
      if(!sel){
        if(!firstMissing) firstMissing=i;
        continue;
      }
      const v=Number(sel.value); // 1=SIM, 0=N√ÉO
      totalYes+=v;
      answers[qn]=v;
    }

    if(firstMissing){
      setBox("#msg", `Responda a quest√£o ${firstMissing}.`, "warn");
      document.getElementById(`lbl${String(firstMissing).padStart(2,"0")}`)?.scrollIntoView({behavior:"smooth",block:"center"});
      sending=false;
      btn.disabled=false;
      btn.textContent=originalText;
      return;
    }

    // double-check se j√° enviou (aba Scores)
    const again=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    if(again && again.length){
      setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // classifica√ß√£o
    const categoria = classif(totalYes);

    // dura√ß√£o
    const durationSec = Math.round((Date.now()-startAt)/1000);

    // m√©tricas extras
    const max_total = ITEMS.length;
    const metricsObj = {
      answers,                         // bruto (ex.: {q01:1,q02:0,...})
      total_yes: totalYes,             // quantos "SIM"
      max_total,                       // 10
      percent_total: Number((totalYes / max_total).toFixed(4)),
      classification: categoria,
      duration_sec: durationSec
    };

    // perguntas + respostas em JSON estruturado
    const questionsArr = collectQuestionsAnswersJSON();

    // grava linha no Scores
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: "",                         // n¬∫ de "SIM"
      categoria: categoria,                    // texto cl√≠nico curto
      metrics: "",
      questions: JSON.stringify(questionsArr)
    });

    // marca como feito no Patients
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}__FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,doneUpdates);

    clearAutosave();
    setBox("#msg","Formul√°rio enviado. Voltando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken,1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false;
    btn.disabled=false;
    btn.textContent=originalText;
  }
});
</script>


</body>
</html>
